# ===============================
# Script: WeeklyMaintenance_v2.ps1
# Maintenance automat sƒÉptƒÉm√¢nal - VERSIUNE √éMBUNƒÇTƒÇ»öITƒÇ
# ===============================
# Requires -RunAsAdministrator

Write-Host "`nüîß MAINTENANCE SƒÇPTƒÇM√ÇNAL v2.0" -ForegroundColor Magenta
Write-Host "================================" -ForegroundColor Magenta
$startTime = Get-Date

# 1. BACKUP REGISTRY (cu arhivare automatƒÉ)
Write-Host "`nüìÅ Backup Registry..." -ForegroundColor Yellow
$backupPath = "$env:USERPROFILE\Documents\RegistryBackups"
if (!(Test-Path $backupPath)) { 
    New-Item -ItemType Directory -Path $backupPath | Out-Null 
}

# »òtergere backup-uri mai vechi de 30 de zile
Get-ChildItem $backupPath -Filter "*.reg" | 
    Where-Object {$_.LastWriteTime -lt (Get-Date).AddDays(-30)} | 
    Remove-Item -Force

$date = Get-Date -Format "yyyy-MM-dd_HHmm"
reg export HKLM "$backupPath\HKLM_$date.reg" /y | Out-Null
reg export HKCU "$backupPath\HKCU_$date.reg" /y | Out-Null
Write-Host "  ‚úì Registry backup salvat √Æn $backupPath" -ForegroundColor Green

# 2. REZOLVARE PROBLEME WINDOWS UPDATE
Write-Host "`nüîß Rezolvare probleme Windows Update..." -ForegroundColor Yellow
# Oprire servicii
Stop-Service -Name wuauserv, bits, cryptsvc -Force -ErrorAction SilentlyContinue

# CurƒÉ»õare cache Windows Update
Remove-Item "C:\Windows\SoftwareDistribution\Download\*" -Force -Recurse -ErrorAction SilentlyContinue
Remove-Item "C:\Windows\System32\catroot2\*" -Force -Recurse -ErrorAction SilentlyContinue

# Repornire servicii
Start-Service -Name wuauserv, bits, cryptsvc -ErrorAction SilentlyContinue
Write-Host "  ‚úì Windows Update cache resetat" -ForegroundColor Green

# 3. ACTUALIZARE SOFTWARE INTELIGENTƒÇ
Write-Host "`nüì¶ Actualizare aplica»õii..." -ForegroundColor Yellow

# Winget cu gestionare erori
Write-Host "  ‚Ä¢ Verificare actualizƒÉri Winget..."
try {
    $updates = winget upgrade --include-unknown 2>$null
    if ($updates -match "upgrades available") {
        Write-Host "    ‚Üí ActualizƒÉri disponibile, instalare..." -ForegroundColor Green
        
        # Exclude VirtualBox dacƒÉ ai VM-uri active
        $vmRunning = Get-Process -Name "VirtualBoxVM" -ErrorAction SilentlyContinue
        if ($vmRunning) {
            Write-Host "    ‚ö†Ô∏è VirtualBox nu va fi actualizat (VM-uri active)" -ForegroundColor Yellow
            winget upgrade --all --silent --accept-package-agreements --accept-source-agreements --exclude "Oracle.VirtualBox"
        } else {
            winget upgrade --all --silent --accept-package-agreements --accept-source-agreements
        }
    } else {
        Write-Host "    ‚úì Toate aplica»õiile sunt actualizate!" -ForegroundColor Green
    }
} catch {
    Write-Host "    ‚ö†Ô∏è Eroare la verificare Winget" -ForegroundColor Yellow
}

# Microsoft Store apps
Write-Host "  ‚Ä¢ Actualizare Microsoft Store apps..."
try {
    Get-CimInstance -Namespace "root\cimv2\mdm\dmmap" -ClassName "MDM_EnterpriseModernAppManagement_AppManagement01" | 
        Invoke-CimMethod -MethodName UpdateScanMethod -ErrorAction SilentlyContinue | Out-Null
    Write-Host "    ‚úì Store apps verificate" -ForegroundColor Green
} catch {
    Write-Host "    ‚ö†Ô∏è Nu s-a putut verifica Store" -ForegroundColor Yellow
}

# 4. SCANARE SECURITATE √éMBUNƒÇTƒÇ»öITƒÇ
Write-Host "`nüõ°Ô∏è Scanare securitate..." -ForegroundColor Yellow

# Update definitions
Write-Host "  ‚Ä¢ Actualizare defini»õii antivirus..."
Update-MpSignature -ErrorAction SilentlyContinue

# Quick scan
Write-Host "  ‚Ä¢ Windows Defender Quick Scan..."
Start-MpScan -ScanType QuickScan -ErrorAction SilentlyContinue

# Verificare amenin»õƒÉri
$threats = Get-MpThreat -ErrorAction SilentlyContinue
if ($threats) {
    Write-Host "  ‚ö†Ô∏è AMENIN»öƒÇRI DETECTATE!" -ForegroundColor Red
    $threats | ForEach-Object { 
        Write-Host "    - $($_.ThreatName) [Severity: $($_.SeverityID)]" -ForegroundColor Red
    }
} else {
    Write-Host "  ‚úì Nu au fost detectate amenin»õƒÉri" -ForegroundColor Green
}

# Verificare firewall
Write-Host "  ‚Ä¢ Verificare Windows Firewall..."
$firewall = Get-NetFirewallProfile | Where-Object {$_.Enabled -eq $false}
if ($firewall) {
    Write-Host "    ‚ö†Ô∏è Firewall dezactivat pentru: $($firewall.Name -join ', ')" -ForegroundColor Red
} else {
    Write-Host "    ‚úì Firewall activ pe toate profilele" -ForegroundColor Green
}

# 5. VERIFICARE HARDWARE CORECTATƒÇ
Write-Host "`nüñ•Ô∏è Verificare hardware..." -ForegroundColor Yellow

# SMART pentru SSD/HDD
Write-Host "  ‚Ä¢ Verificare SMART pentru discuri..."
Get-PhysicalDisk | ForEach-Object {
    $disk = $_
    $health = Get-StorageReliabilityCounter -PhysicalDisk $disk -ErrorAction SilentlyContinue
    if ($health) {
        $temp = if ($health.Temperature) { "$($health.Temperature)¬∞C" } else { "N/A" }
        $status = if ($disk.HealthStatus -eq "Healthy") { "‚úì" } else { "‚ö†Ô∏è" }
        Write-Host "    $status Disk $($disk.FriendlyName): Health = $($disk.HealthStatus), Temp = $temp"
        
        # Avertizare pentru temperaturi mari
        if ($health.Temperature -and $health.Temperature -gt 60) {
            Write-Host "      ‚ö†Ô∏è ATEN»öIE: Temperatura discului este mare!" -ForegroundColor Red
        }
    }
}

# Verificare baterie √éMBUNƒÇTƒÇ»öITƒÇ
$batteries = @(Get-CimInstance -ClassName Win32_Battery -ErrorAction SilentlyContinue)
if ($batteries.Count -gt 0) {
    Write-Host "  ‚Ä¢ Status baterii laptop ($($batteries.Count) baterii):"
    
    for ($i = 0; $i -lt $batteries.Count; $i++) {
        $bat = $batteries[$i]
        Write-Host "    Bateria $($i + 1):"
        
        try {
            if ($bat.DesignCapacity -and $bat.FullChargeCapacity -and $bat.FullChargeCapacity -gt 0) {
                $healthPercent = [math]::Round(($bat.FullChargeCapacity / $bat.DesignCapacity) * 100, 2)
                Write-Host "      ‚Üí SƒÉnƒÉtate: $healthPercent% din capacitatea originalƒÉ"
                
                if ($healthPercent -lt 80) {
                    Write-Host "        ‚ö†Ô∏è Bateria ar putea necesita √Ænlocuire" -ForegroundColor Yellow
                } elseif ($healthPercent -gt 90) {
                    Write-Host "        ‚úì Baterie √Æn stare excelentƒÉ" -ForegroundColor Green
                }
            }
            
            if ($bat.EstimatedChargeRemaining) {
                $chargePercent = $bat.EstimatedChargeRemaining
                Write-Host "      ‚Üí √éncƒÉrcare curentƒÉ: $chargePercent%"
                
                if ($chargePercent -lt 20) {
                    Write-Host "        ‚ö†Ô∏è Baterie descƒÉrcatƒÉ!" -ForegroundColor Yellow
                }
            }
            
            $status = switch ($bat.BatteryStatus) {
                1 { "Other" }
                2 { "Unknown" }
                3 { "Fully Charged" }
                4 { "Low" }
                5 { "Critical" }
                6 { "Charging" }
                7 { "Charging and High" }
                8 { "Charging and Low" }
                9 { "Charging and Critical" }
                10 { "Undefined" }
                11 { "Partially Charged" }
                default { "Status necunoscut ($($bat.BatteryStatus))" }
            }
            Write-Host "      ‚Üí Status: $status"
            
        } catch {
            Write-Host "      ‚ö†Ô∏è Nu s-au putut citi detaliile acestei baterii" -ForegroundColor Yellow
        }
    }
} else {
    Write-Host "  ‚Ä¢ Nu au fost detectate baterii (sistem desktop)" -ForegroundColor Gray
}

# 6. OPTIMIZARE STARTUP √éMBUNƒÇTƒÇ»öITƒÇ
Write-Host "`n‚ö° Optimizare startup..." -ForegroundColor Yellow
$startupItems = Get-CimInstance Win32_StartupCommand
Write-Host "  ‚Ä¢ Total programe la startup: $($startupItems.Count)"

# Identificare programe grele la startup
$heavyStartups = @("Steam", "Skype", "Teams", "Discord", "Spotify")
$foundHeavy = $startupItems | Where-Object { 
    $heavyStartups -contains ($_.Name -replace '\s.*$','')
}

if ($foundHeavy) {
    Write-Host "  ‚ö†Ô∏è Programe grele detectate la startup:" -ForegroundColor Yellow
    $foundHeavy | ForEach-Object { Write-Host "    - $($_.Name)" }
    Write-Host "    üí° ConsiderƒÉ dezactivarea lor din Task Manager > Startup" -ForegroundColor Cyan
}

# 7. CURƒÇ»öARE BROWSERE EXTINSƒÇ
Write-Host "`nüåê CurƒÉ»õare cache browsere..." -ForegroundColor Yellow

# Chrome
$chromePaths = @(
    "$env:LOCALAPPDATA\Google\Chrome\User Data\Default\Cache",
    "$env:LOCALAPPDATA\Google\Chrome\User Data\Default\Code Cache",
    "$env:LOCALAPPDATA\Google\Chrome\User Data\Default\Service Worker"
)
foreach ($path in $chromePaths) {
    if (Test-Path $path) {
        Write-Host "  ‚Ä¢ CurƒÉ»õare Chrome: $(Split-Path $path -Leaf)..."
        Remove-Item "$path\*" -Force -Recurse -ErrorAction SilentlyContinue
    }
}

# Edge
$edgePaths = @(
    "$env:LOCALAPPDATA\Microsoft\Edge\User Data\Default\Cache",
    "$env:LOCALAPPDATA\Microsoft\Edge\User Data\Default\Code Cache",
    "$env:LOCALAPPDATA\Microsoft\Edge\User Data\Default\Service Worker"
)
foreach ($path in $edgePaths) {
    if (Test-Path $path) {
        Write-Host "  ‚Ä¢ CurƒÉ»õare Edge: $(Split-Path $path -Leaf)..."
        Remove-Item "$path\*" -Force -Recurse -ErrorAction SilentlyContinue
    }
}

# Firefox
$firefoxPath = "$env:LOCALAPPDATA\Mozilla\Firefox\Profiles"
if (Test-Path $firefoxPath) {
    Write-Host "  ‚Ä¢ CurƒÉ»õare Firefox cache..."
    Get-ChildItem $firefoxPath -Directory | ForEach-Object {
        Remove-Item "$($_.FullName)\cache2\*" -Force -Recurse -ErrorAction SilentlyContinue
    }
}

# 8. CURƒÇ»öARE FI»òIERE TEMPORARE EXTINSE
Write-Host "`nüóëÔ∏è CurƒÉ»õare fi»ôiere temporare..." -ForegroundColor Yellow
$tempPaths = @(
    "$env:TEMP",
    "C:\Windows\Temp",
    "C:\Windows\Prefetch",
    "$env:LOCALAPPDATA\Temp",
    "C:\ProgramData\Microsoft\Windows\WER",
    "$env:LOCALAPPDATA\CrashDumps"
)

$totalFreed = 0
foreach ($path in $tempPaths) {
    if (Test-Path $path) {
        $before = (Get-ChildItem $path -Recurse -ErrorAction SilentlyContinue | 
                  Measure-Object -Property Length -Sum).Sum / 1MB
        
        Remove-Item "$path\*" -Force -Recurse -ErrorAction SilentlyContinue
        
        $after = (Get-ChildItem $path -Recurse -ErrorAction SilentlyContinue | 
                 Measure-Object -Property Length -Sum).Sum / 1MB
        
        $freed = [math]::Round($before - $after, 2)
        $totalFreed += $freed
        
        if ($freed -gt 0) {
            Write-Host "  ‚Ä¢ $(Split-Path $path -Leaf): $freed MB eliberat"
        }
    }
}
Write-Host "  ‚úì Total eliberat: $([math]::Round($totalFreed, 2)) MB" -ForegroundColor Green

# 9. VERIFICARE EVENT LOG √éMBUNƒÇTƒÇ»öITƒÇ
Write-Host "`nüìã AnalizƒÉ Event Log..." -ForegroundColor Yellow
$criticalErrors = @{
    "Service Control Manager" = 0
    "Microsoft-Windows-WindowsUpdateClient" = 0
    "DCOM" = 0
    "Application Error" = 0
}

$errors = Get-EventLog -LogName System -EntryType Error -Newest 50 -ErrorAction SilentlyContinue
foreach ($error in $errors) {
    if ($criticalErrors.ContainsKey($error.Source)) {
        $criticalErrors[$error.Source]++
    }
}

Write-Host "  ‚Ä¢ Sumar erori critice (ultimele 50):"
foreach ($source in $criticalErrors.Keys) {
    $count = $criticalErrors[$source]
    if ($count -gt 0) {
        $color = if ($count -gt 5) { "Red" } elseif ($count -gt 2) { "Yellow" } else { "White" }
        Write-Host "    - $source`: $count erori" -ForegroundColor $color
    }
}

# Verificare probleme SQL Server
if ($errors | Where-Object {$_.Source -like "*SQL*"}) {
    Write-Host "  ‚ö†Ô∏è Probleme SQL Server detectate!" -ForegroundColor Yellow
    Write-Host "    üí° RuleazƒÉ scriptul de optimizare SQL Server" -ForegroundColor Cyan
}

# 10. OPTIMIZARE WINDOWS SEARCH
Write-Host "`nüîç Optimizare Windows Search..." -ForegroundColor Yellow
Write-Host "  ‚Ä¢ Verificare serviciu Windows Search..."
$searchService = Get-Service WSearch -ErrorAction SilentlyContinue
if ($searchService.Status -ne "Running") {
    Start-Service WSearch -ErrorAction SilentlyContinue
    Write-Host "    ‚Üí Serviciu pornit" -ForegroundColor Green
} else {
    Write-Host "    ‚úì Serviciu func»õional" -ForegroundColor Green
}

# 11. CREARE RESTORE POINT
Write-Host "`nüíæ Creare System Restore Point..." -ForegroundColor Yellow
try {
    Enable-ComputerRestore -Drive "C:\" -ErrorAction SilentlyContinue
    Checkpoint-Computer -Description "Weekly Maintenance $(Get-Date -Format 'yyyy-MM-dd HH:mm')" `
                       -RestorePointType "MODIFY_SETTINGS" -ErrorAction Stop
    Write-Host "  ‚úì Restore point creat cu succes" -ForegroundColor Green
} catch {
    Write-Host "  ‚ö†Ô∏è Nu s-a putut crea restore point" -ForegroundColor Yellow
}

# 12. VERIFICARE SPA»öIU PE DISC
Write-Host "`nüíæ Verificare spa»õiu pe disc..." -ForegroundColor Yellow
Get-PSDrive -PSProvider FileSystem | Where-Object {$_.Free -ne $null} | ForEach-Object {
    $percentFree = [math]::Round(($_.Free / ($_.Used + $_.Free)) * 100, 2)
    $color = if ($percentFree -lt 10) { "Red" } elseif ($percentFree -lt 20) { "Yellow" } else { "Green" }
    
    Write-Host "  ‚Ä¢ Drive $($_.Name): $percentFree% liber ($([math]::Round($_.Free/1GB, 2)) GB)" -ForegroundColor $color
    
    if ($percentFree -lt 10) {
        Write-Host "    ‚ö†Ô∏è ATEN»öIE: Spa»õiu critic pe disc!" -ForegroundColor Red
        Write-Host "    üí° RuleazƒÉ scriptul de curƒÉ»õare profundƒÉ" -ForegroundColor Cyan
    }
}

# 13. RAPORT FINAL
$endTime = Get-Date
$duration = $endTime - $startTime

Write-Host "`n" 
Write-Host "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê" -ForegroundColor Green
Write-Host " üìä RAPORT MAINTENANCE COMPLETAT" -ForegroundColor Green  
Write-Host "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê" -ForegroundColor Green
Write-Host "‚è±Ô∏è  Durata: $($duration.Minutes) min »ôi $($duration.Seconds) sec"
Write-Host "üìÖ Data: $(Get-Date -Format 'dd/MM/yyyy HH:mm')"
Write-Host "üñ•Ô∏è  Computer: $env:COMPUTERNAME"
Write-Host "üë§ Utilizator: $env:USERNAME"

# Status general sistem
$cpu = Get-Counter '\Processor(_Total)\% Processor Time' -ErrorAction SilentlyContinue
$mem = Get-CimInstance Win32_OperatingSystem
$memUsed = ($mem.TotalVisibleMemorySize - $mem.FreePhysicalMemory) / $mem.TotalVisibleMemorySize * 100

Write-Host "`nüìà Status Sistem:"
Write-Host "  ‚Ä¢ CPU: $([math]::Round($cpu.CounterSamples.CookedValue, 2))%"
Write-Host "  ‚Ä¢ RAM: $([math]::Round($memUsed, 2))% utilizat"
Write-Host "  ‚Ä¢ Uptime: $((Get-CimInstance Win32_OperatingSystem).LastBootUpTime | Get-Date -Format 'dd/MM HH:mm')"

# Salvare log
$logPath = "$env:USERPROFILE\Documents\MaintenanceLogs"
if (!(Test-Path $logPath)) { 
    New-Item -ItemType Directory -Path $logPath | Out-Null 
}

$logFile = "$logPath\Maintenance_$(Get-Date -Format 'yyyy-MM-dd_HHmm').log"
@"
Maintenance Report - $(Get-Date)
Duration: $($duration.TotalMinutes) minutes
Computer: $env:COMPUTERNAME
User: $env:USERNAME
Status: Completed Successfully
"@ | Out-File $logFile

Write-Host "`n‚úÖ Toate taskurile finalizate cu succes!" -ForegroundColor Green
Write-Host "üìù Log salvat √Æn: $logFile" -ForegroundColor Cyan

# Sugestii bazate pe probleme gƒÉsite
Write-Host "`nüí° RECOMANDƒÇRI:" -ForegroundColor Cyan
if ($errors | Where-Object {$_.Source -eq "Microsoft-Windows-WindowsUpdateClient"}) {
    Write-Host "  ‚Ä¢ RuleazƒÉ Windows Update Troubleshooter"
}
if ($criticalErrors["DCOM"] -gt 5) {
    Write-Host "  ‚Ä¢ VerificƒÉ permisiunile DCOM √Æn Component Services"
}
if ($memUsed -gt 80) {
    Write-Host "  ‚Ä¢ ConsiderƒÉ upgrade RAM sau √Ænchidere aplica»õii"
}

Write-Host "`nüîÑ UrmƒÉtorul maintenance: $((Get-Date).AddDays(7).ToString('dd/MM/yyyy'))" -ForegroundColor Gray