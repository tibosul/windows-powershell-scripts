# ===============================
# Script: DriverUpdateAutomation.ps1
# Actualizare automatƒÉ drivere sistem
# Versiune √ÆmbunƒÉtƒÉ»õitƒÉ cu logging »ôi automatizare
# ===============================

# NecesitƒÉ rulare ca Administrator
if (-not ([Security.Principal.WindowsPrincipal][Security.Principal.WindowsIdentity]::GetCurrent()).IsInRole([Security.Principal.WindowsBuiltInRole]::Administrator)) {
    Write-Host "‚ö†Ô∏è RuleazƒÉ PowerShell ca Administrator!" -ForegroundColor Red
    exit
}

# Configurare logging
$logPath = "$env:TEMP\DriverUpdate_$(Get-Date -Format 'yyyyMMdd_HHmmss').log"
$global:LogEnabled = $true

function Write-Log {
    param([string]$Message, [string]$Level = "INFO")
    $timestamp = Get-Date -Format "yyyy-MM-dd HH:mm:ss"
    $logEntry = "[$timestamp] [$Level] $Message"
    
    if ($global:LogEnabled) {
        Add-Content -Path $logPath -Value $logEntry -ErrorAction SilentlyContinue
    }
    
    # Afi»ôeazƒÉ √Æn consolƒÉ cu culori
    switch ($Level) {
        "ERROR" { Write-Host $logEntry -ForegroundColor Red }
        "WARNING" { Write-Host $logEntry -ForegroundColor Yellow }
        "SUCCESS" { Write-Host $logEntry -ForegroundColor Green }
        default { Write-Host $logEntry -ForegroundColor White }
    }
}

function Update-SystemDrivers {
    Write-Log "√éncepere actualizare drivere prin Windows Update" "INFO"
    Write-Host "`nüîß ACTUALIZARE AUTOMATƒÇ DRIVERE..." -ForegroundColor Yellow

    # VerificƒÉ Windows Update PowerShell Module
    if (-not (Get-Module -ListAvailable -Name PSWindowsUpdate)) {
        Write-Log "Instalare PSWindowsUpdate module" "INFO"
        try {
            Install-Module PSWindowsUpdate -Force -Scope CurrentUser
            Write-Log "PSWindowsUpdate instalat cu succes" "SUCCESS"
        }
        catch {
            Write-Log "Eroare la instalarea PSWindowsUpdate: $($_.Exception.Message)" "ERROR"
            return
        }
    }

    # Import module
    Import-Module PSWindowsUpdate -Force
    Write-Log "Module PSWindowsUpdate importat" "SUCCESS"

    Write-Log "Scanare drivere disponibile prin Windows Update" "INFO"

    # ScaneazƒÉ pentru drivere prin Windows Update
    try {
        $drivers = Get-WUList -Category "Drivers" -IsInstalled $false

        if ($drivers.Count -eq 0) {
            Write-Log "Toate driverele sunt actualizate" "SUCCESS"
            return
        }

        Write-Log "GƒÉsite $($drivers.Count) drivere pentru actualizare" "INFO"
        Write-Host "`nüìã Drivere gƒÉsite pentru actualizare:" -ForegroundColor Yellow
        foreach ($driver in $drivers) {
            Write-Host "  ‚Ä¢ $($driver.Title)" -ForegroundColor White
            Write-Log "Driver disponibil: $($driver.Title)" "INFO"
        }

        # ConfirmƒÉ actualizarea
        $response = Read-Host "`n‚ùì Dore»ôti sƒÉ instalezi aceste drivere? (y/N)"
        if ($response -eq 'y' -or $response -eq 'Y') {
            Write-Log "Utilizatorul a confirmat instalarea driverelor" "INFO"
            Write-Host "`n‚¨áÔ∏è DescƒÉrcare »ôi instalare drivere..." -ForegroundColor Cyan
            Install-WindowsUpdate -Category "Drivers" -AcceptAll -AutoReboot:$false
            Write-Log "Drivere instalate cu succes prin Windows Update" "SUCCESS"
            Write-Host "‚ö†Ô∏è Se recomandƒÉ repornirea sistemului." -ForegroundColor Yellow
        }
        else {
            Write-Log "Actualizare anulatƒÉ de utilizator" "WARNING"
        }
    }
    catch {
        Write-Log "Eroare la scanarea driverelor: $($_.Exception.Message)" "ERROR"
    }
}

function Update-DriversWithPnpUtil {
    Write-Log "√éncepere actualizare drivere cu PnpUtil" "INFO"
    Write-Host "`nüîß ACTUALIZARE DRIVERE CU PNPUTIL..." -ForegroundColor Yellow

    try {
        # ScaneazƒÉ pentru drivere cu probleme
        Write-Log "Scanare drivere cu probleme" "INFO"
        $problemDevices = Get-PnpDevice | Where-Object { $_.Status -eq "Error" -or $_.Status -eq "Unknown" }

        if ($problemDevices.Count -eq 0) {
            Write-Log "Nu sunt drivere cu probleme detectate" "SUCCESS"
        }
        else {
            Write-Log "GƒÉsite $($problemDevices.Count) dispozitive cu probleme" "WARNING"
            Write-Host "`n‚ö†Ô∏è Dispozitive cu probleme gƒÉsite:" -ForegroundColor Yellow
            foreach ($device in $problemDevices) {
                Write-Host "  ‚Ä¢ $($device.FriendlyName) - Status: $($device.Status)" -ForegroundColor Red
                Write-Log "Dispozitiv cu probleme: $($device.FriendlyName) - Status: $($device.Status)" "WARNING"
            }
        }

        # √éncearcƒÉ actualizarea automatƒÉ prin PnpUtil
        Write-Log "Executare PnpUtil scan-devices" "INFO"
        & pnputil /scan-devices 2>&1 | Out-Null

        if ($LASTEXITCODE -eq 0) {
            Write-Log "Scanare completƒÉ prin PnpUtil reu»ôitƒÉ" "SUCCESS"
        }
        else {
            Write-Log "PnpUtil scanare completƒÉ cu warnings (Exit Code: $LASTEXITCODE)" "WARNING"
        }
    }
    catch {
        Write-Log "Eroare la actualizarea cu PnpUtil: $($_.Exception.Message)" "ERROR"
    }
}

function Show-DriverReport {
    Write-Log "Generare raport drivere sistem" "INFO"
    Write-Host "`nüìä RAPORT DRIVERE SISTEM..." -ForegroundColor Yellow

    try {
        # Ob»õine toate driverele instalate folosind Get-CimInstance
        Write-Log "Colectare informa»õii drivere cu Get-CimInstance" "INFO"
        $drivers = Get-CimInstance -ClassName Win32_PnPSignedDriver | Sort-Object DeviceName
        $totalDrivers = $drivers.Count

        Write-Log "GƒÉsite $totalDrivers drivere instalate" "INFO"

        # ContorizeazƒÉ driverele dupƒÉ status
        $signedDrivers = ($drivers | Where-Object { $_.IsSigned -eq $true }).Count
        $unsignedDrivers = $totalDrivers - $signedDrivers

        # Afi»ôeazƒÉ statistici
        Write-Host "`nüìà STATISTICI DRIVERE:" -ForegroundColor Cyan
        Write-Host "  ‚Ä¢ Total drivere instalate: $totalDrivers" -ForegroundColor White
        Write-Host "  ‚Ä¢ Drivere semnate digital: $signedDrivers" -ForegroundColor Green
        Write-Host "  ‚Ä¢ Drivere nesemnate: $unsignedDrivers" -ForegroundColor $(if($unsignedDrivers -gt 0) { "Yellow" } else { "Green" })

        Write-Log "Statistici: Total=$totalDrivers, Semnate=$signedDrivers, Nesemnate=$unsignedDrivers" "INFO"

        # Afi»ôeazƒÉ driverele recente (ultimele 10)
        Write-Host "`nüìÖ DRIVERE INSTALATE RECENT (Top 10):" -ForegroundColor Cyan
        $recentDrivers = $drivers | Where-Object { $null -ne $_.DriverDate } |
                        Sort-Object @{Expression={[DateTime]$_.DriverDate}; Descending=$true} |
                        Select-Object -First 10

        foreach ($driver in $recentDrivers) {
            $date = if($driver.DriverDate) { ([DateTime]$driver.DriverDate).ToString("yyyy-MM-dd") } else { "N/A" }
            Write-Host "  ‚Ä¢ $($driver.DeviceName) - $date" -ForegroundColor White
            Write-Log "Driver recent: $($driver.DeviceName) - $date" "INFO"
        }

        # VerificƒÉ dispozitivele cu probleme
        Write-Host "`n‚ö†Ô∏è DISPOZITIVE CU PROBLEME:" -ForegroundColor Yellow
        $problemDevices = Get-PnpDevice | Where-Object { $_.Status -ne "OK" }

        if ($problemDevices.Count -eq 0) {
            Write-Log "Nu sunt dispozitive cu probleme" "SUCCESS"
        }
        else {
            Write-Log "GƒÉsite $($problemDevices.Count) dispozitive cu probleme" "WARNING"
            foreach ($device in $problemDevices) {
                Write-Host "  ‚Ä¢ $($device.FriendlyName) - Status: $($device.Status)" -ForegroundColor Red
                Write-Log "Dispozitiv cu probleme: $($device.FriendlyName) - $($device.Status)" "WARNING"
            }
        }
        
        Write-Log "Raport drivere completat cu succes" "SUCCESS"
    }
    catch {
        Write-Log "Eroare la generarea raportului: $($_.Exception.Message)" "ERROR"
    }
}

function Update-DriversWithWinget {
    Write-Log "√éncepere actualizare drivere prin Winget" "INFO"
    Write-Host "`nüîß VERIFICARE ACTUALIZƒÇRI DRIVERE PRIN WINGET..." -ForegroundColor Yellow

    try {
        # VerificƒÉ dacƒÉ winget este disponibil
        $wingetCheck = Get-Command winget -ErrorAction SilentlyContinue
        if (-not $wingetCheck) {
            Write-Log "Winget nu este disponibil pe acest sistem" "ERROR"
            return
        }

        Write-Log "Winget detectat, √Æncepere scanare" "SUCCESS"

        # Lista de drivere comune care pot fi actualizate prin winget
        $commonDrivers = @(
            "Nvidia.GeForceExperience",
            "AMD.AMDSoftwareAdrenalin",
            "Intel.IntelDriverAndSupportAssistant",
            "Realtek.AudioDriver",
            "Intel.GraphicsDriver"
        )

        Write-Log "Verificare $($commonDrivers.Count) drivere comune" "INFO"
        foreach ($driver in $commonDrivers) {
            Write-Log "Verificare disponibilitate: $driver" "INFO"
            winget show $driver 2>&1 | Out-Null
            if ($LASTEXITCODE -eq 0) {
                Write-Log "Driver disponibil: $driver" "SUCCESS"
            }
            else {
                Write-Log "Driver nu este instalat/disponibil: $driver" "WARNING"
            }
        }

        # √éncearcƒÉ actualizarea tuturor aplica»õiilor (include »ôi driverele)
        Write-Log "Executare actualizare completƒÉ prin Winget" "INFO"
        winget upgrade --all --silent --accept-source-agreements --accept-package-agreements | Out-Null

        Write-Log "Actualizare Winget completatƒÉ cu succes" "SUCCESS"
    }
    catch {
        Write-Log "Eroare la actualizarea prin Winget: $($_.Exception.Message)" "ERROR"
    }
}

function Update-DriversWithChocolatey {
    Write-Log "√éncepere actualizare drivere prin Chocolatey" "INFO"
    Write-Host "`nüç´ VERIFICARE ACTUALIZƒÇRI DRIVERE PRIN CHOCOLATEY..." -ForegroundColor Yellow

    try {
        # VerificƒÉ dacƒÉ Chocolatey este instalat
        $chocoCheck = Get-Command choco -ErrorAction SilentlyContinue
        if (-not $chocoCheck) {
            Write-Log "Chocolatey nu este instalat pe acest sistem" "WARNING"
            Write-Host "üí° Dore»ôti sƒÉ instalezi Chocolatey? (Y/N)" -ForegroundColor Yellow
            $installChoco = Read-Host
            
            if ($installChoco -eq 'Y' -or $installChoco -eq 'y') {
                Write-Log "Instalare Chocolatey" "INFO"
                Set-ExecutionPolicy Bypass -Scope Process -Force
                [System.Net.ServicePointManager]::SecurityProtocol = [System.Net.ServicePointManager]::SecurityProtocol -bor 3072
                Invoke-Expression ((New-Object System.Net.WebClient).DownloadString('https://community.chocolatey.org/install.ps1'))
                
                if (Get-Command choco -ErrorAction SilentlyContinue) {
                    Write-Log "Chocolatey instalat cu succes" "SUCCESS"
                } else {
                    Write-Log "Eroare la instalarea Chocolatey" "ERROR"
                    return
                }
            } else {
                Write-Log "Chocolatey nu a fost instalat, sƒÉri peste aceastƒÉ sec»õiune" "INFO"
                return
            }
        }

        Write-Log "Chocolatey detectat, √Æncepere scanare" "SUCCESS"

        # Lista de pachete drivere comune √Æn Chocolatey
        $chocoDrivers = @(
            "nvidia-display-driver",
            "amd-ryzen-chipset-driver",
            "intel-chipset-device-software",
            "realtek-audio-driver",
            "intel-graphics-driver"
        )

        Write-Log "Verificare $($chocoDrivers.Count) pachete drivere Chocolatey" "INFO"
        foreach ($package in $chocoDrivers) {
            Write-Log "Verificare pachet: $package" "INFO"
            $result = choco list $package --local-only 2>&1
            if ($LASTEXITCODE -eq 0 -and $result -match $package) {
                Write-Log "Pachet instalat gƒÉsit: $package" "SUCCESS"
            }
            else {
                Write-Log "Pachet nu este instalat: $package" "WARNING"
            }
        }

        # ActualizeazƒÉ toate pachetele instalate
        Write-Log "Executare actualizare completƒÉ prin Chocolatey" "INFO"
        choco upgrade all -y | Out-Null

        Write-Log "Actualizare Chocolatey completatƒÉ cu succes" "SUCCESS"
    }
    catch {
        Write-Log "Eroare la actualizarea prin Chocolatey: $($_.Exception.Message)" "ERROR"
    }
}

function Start-AutomaticDriverUpdate {
    Write-Log "√éncepere actualizare automatƒÉ completƒÉ" "INFO"
    Write-Host "`nüöÄ RULARE AUTOMATƒÇ COMPLETƒÇ..." -ForegroundColor Magenta
    Write-Host "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê" -ForegroundColor Magenta
    
    $startTime = Get-Date
    
    # ExecutƒÉ toate func»õiile √Æn ordine
    Show-DriverReport
    Update-DriversWithPnpUtil
    Update-DriversWithWinget
    Update-DriversWithChocolatey
    Update-SystemDrivers
    
    $endTime = Get-Date
    $duration = $endTime - $startTime
    
    Write-Log "Actualizare automatƒÉ completƒÉ finalizatƒÉ √Æn $($duration.TotalMinutes) minute" "SUCCESS"
    Write-Host "`n‚úÖ Actualizare automatƒÉ completƒÉ!" -ForegroundColor Green
    Write-Host "‚è±Ô∏è Durata totalƒÉ: $($duration.Minutes)m $($duration.Seconds)s" -ForegroundColor Cyan
    Write-Host "üìÑ Log complet: $logPath" -ForegroundColor Gray
}

function Show-DriverUpdateMenu {
    Write-Log "Pornire aplica»õie actualizare drivere" "INFO"
    
    Write-Host ""
    Write-Host "‚ïî‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïó" -ForegroundColor Cyan
    Write-Host "‚ïë              üîß ACTUALIZARE AUTOMATƒÇ DRIVERE            ‚ïë" -ForegroundColor Cyan
    Write-Host "‚ïë                  ‚ú® Versiune √ÆmbunƒÉtƒÉ»õitƒÉ                ‚ïë" -ForegroundColor Magenta
    Write-Host "‚ïö‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïù" -ForegroundColor Cyan
    Write-Host ""
    Write-Host "üìÑ Log fi»ôier: $logPath" -ForegroundColor Gray
    Write-Host ""
    Write-Host "  [1] üîç Raport drivere sistem" -ForegroundColor White
    Write-Host "  [2] üîß Actualizare prin Windows Update" -ForegroundColor White
    Write-Host "  [3] ‚ö° Scanare »ôi reparare cu PnpUtil" -ForegroundColor White
    Write-Host "  [4] üì¶ Actualizare drivere prin Winget" -ForegroundColor White
    Write-Host "  [5] üç´ Actualizare drivere prin Chocolatey" -ForegroundColor White
    Write-Host "  [6] üöÄ Actualizare completƒÉ (toate metodele)" -ForegroundColor White
    Write-Host "  [7] ü§ñ RULARE AUTOMATƒÇ COMPLETƒÇ" -ForegroundColor Green
    Write-Host "  [8] üìÑ Afi»ôeazƒÉ log-ul" -ForegroundColor Yellow
    Write-Host "  [0] ‚ùå √énapoi" -ForegroundColor Red
    Write-Host ""

    $choice = Read-Host "Alege op»õiunea"

    switch ($choice) {
        "1" { Show-DriverReport }
        "2" { Update-SystemDrivers }
        "3" { Update-DriversWithPnpUtil }
        "4" { Update-DriversWithWinget }
        "5" { Update-DriversWithChocolatey }
        "6" {
            Show-DriverReport
            Update-DriversWithPnpUtil
            Update-DriversWithWinget
            Update-DriversWithChocolatey
            Update-SystemDrivers
        }
        "7" { Start-AutomaticDriverUpdate }
        "8" { 
            if (Test-Path $logPath) {
                Write-Host "`nüìÑ CON»öINUT LOG:" -ForegroundColor Yellow
                Get-Content $logPath | ForEach-Object { Write-Host $_ }
            } else {
                Write-Host "‚ùå Log-ul nu a fost gƒÉsit!" -ForegroundColor Red
            }
        }
        "0" { return }
        default {
            Write-Log "Op»õiune invalidƒÉ selectatƒÉ: $choice" "ERROR"
            Write-Host "‚ùå Op»õiune invalidƒÉ!" -ForegroundColor Red
            Start-Sleep 2
            Show-DriverUpdateMenu
        }
    }

    Write-Host "`n‚úÖ Opera»õiune completƒÉ! ApasƒÉ Enter pentru a continua..."
    Read-Host
    Show-DriverUpdateMenu
}

# RuleazƒÉ func»õia principalƒÉ dacƒÉ script-ul este executat direct
if ($MyInvocation.InvocationName -eq $MyInvocation.MyCommand.Name) {
    Show-DriverUpdateMenu
}